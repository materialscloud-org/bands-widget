// Materials Cloud bands structure widget v1.1.0
// https://www.materialscloud.org
// Contributors: Materials Cloud team <info@materialscloud.org>
// (c) 2020, Released under the MIT License

var zip=function(){var n=[].slice.call(arguments);return(0===n.length?[]:n.reduce(function(t,e){return t.length<e.length?t:e})).map(function(t,e){return n.map(function(t){return t[e]})})};function getPathStringFromPathArray(t){var e=[],n="";return t.forEach(function(t){0===e.length?e+=t[0]:n!=t[0]&&(e+="|"+t[0]),e+="-",e+=t[1],n=t[1]}),e}function getPathArrayFromPathString(t){var n=[];return t.split("|").forEach(function(t){var e=t.split("-").map(function(t){return t.trim()}).filter(function(t){return""!==t});zip(e.slice(0,e.length-1),e.slice(1)).forEach(function(t){n.push([t[0],t[1]])})}),n}function getValidPointNames(t){var e=[];t.forEach(function(t){t.hasOwnProperty("paths")&&t.paths.forEach(function(t){e.push(t.from),e.push(t.to)})});var n=Array.from(new Set(e));return n.sort(),n}function BandPlot(t,e,n){this.divID=t,this.allData=[],this.allSeries=[],this.allColorInfo=[],this.currentPath=[],this.fermiEnergy=e,this.yLimit=n,this.yLabel="",void 0!==this.myChart&&this.myChart.destroy()}BandPlot.prototype.addBandStructure=function(t,e){var n,r,a=["#555555","#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00"];void 0===e&&(n=this.allColorInfo.length,e=[(r=tinycolor(a[n%a.length])).toHexString(),r.darken(20).toHexString(),r.brighten(20).toHexString()]),this.allColorInfo.push(e),this.allData.push(t)},BandPlot.prototype.initChart=function(t){var e=this,n={type:"scatter",data:{datasets:this.allSeries},options:{legend:{display:!1},animation:{duration:0},hover:{animationDuration:0,mode:null},responsiveAnimationDuration:0,elements:{line:{tension:0}},responsive:!0,maintainAspectRatio:!1,tooltips:!1,scales:{xAxes:[{display:!0,ticks:{callback:function(t,e,n){return this.options.customTicks[e].label}},customTicks:t,afterBuildTicks:function(t,e){return t.options.customTicks.map(function(t){return t.value})}}],yAxes:[{display:!0,ticks:{callback:function(t,e,n){if(0!==e&&e!=n.length-1)return t}},scaleLabel:{display:!0},gridLines:{display:!1}}]},zoom:{enabled:!0,mode:"y",drag:!0}}};e.yLimit&&(n.options.scales.yAxes[0].ticks.min=e.yLimit.ymin,n.options.scales.yAxes[0].ticks.max=e.yLimit.ymax),e.xLimit&&(n.options.scales.xAxes[0].ticks.min=e.xLimit.xmin,n.options.scales.xAxes[0].ticks.max=e.xLimit.xmax),e.yLabel&&(n.options.scales.yAxes[0].scaleLabel.labelString=e.yLabel);var r=document.getElementById(this.divID).getContext("2d");e.myChart=new Chart(r,n)},BandPlot.prototype.getDefaultPath=function(){return 0<this.allData.length?this.allData[0].path:[]},BandPlot.prototype.updateBandPlot=function(t,e){var m=this,n=null;void 0===e&&(e=!1);var p,s,r,n=void 0===t?m.getDefaultPath():t,a=!1;m.currentPath.length!=n.length?a=!0:zip(m.currentPath,n).forEach(function(t){t[0][0]!=t[1][0]&&(a=!0),t[0][1]!=t[1][1]&&(a=!0)}),(a||e)&&(m.currentPath=n,p=0,s=[],m.allSeries=[],n.forEach(function(f,t){0===s.length?s.push([p,f[0]]):s[s.length-1][1]!=f[0]&&(s[s.length-1][1]+="|"+f[0]);var r,a=!1,i=null;m.allData.forEach(function(t,o){var l=function(t,e){for(var n=0;n<e.length;n++){var r=e[n];if(r.from==t[0]&&r.to==t[1])return{segment:r,reverse:!1};if(r.from==t[1]&&r.to==t[0])return{segment:r,reverse:!0}}return null}(f,t.paths);if(l){a=!0;var c=[],e=l.segment.x.length;if(l.reverse)for(r=l.segment.x.length-1;0<=r;r--)c.push(l.segment.x[e-1]-l.segment.x[r]);else for(r=0;r<e;r++)c.push(l.segment.x[r]-l.segment.x[0]);var u=l.segment.two_band_types||!1,h=l.segment.values.length;null===i&&(i=c[c.length-1]);var n;if(0<c[c.length-1])for(n=i/c[c.length-1],r=0;r<c.length;r++)c[r]*=n;0<i&&l.segment.values.forEach(function(t,e){var n,r=[];n=l.reverse?t.slice().reverse():t,m.fermiEnergy&&(n=n.map(function(t){return t-m.fermiEnergy})),zip(c,n).forEach(function(t){r.push({x:t[0]+p,y:t[1]})});var a=m.allColorInfo[o],i=null,i=u?2*e<h?a[1]:a[2]:a[0],s={label:f[0]+"-"+f[1]+"."+e,borderColor:i,borderWidth:2,data:r,fill:!1,showLine:!0,pointRadius:0};m.allSeries.push(s)})}}),p+=a&&0<i?i:.1,s.push([p,f[1]])}),r=m.updateTicks(s).map(function(t,e){return{value:t[0],label:t[1]}}),m.xLimit={xmin:0,xmax:p},m.yLabel=m.allData[0].Y_label,void 0===m.yLabel&&(m.yLabel="Electronic bands (eV)"),void 0===m.myChart?m.initChart(r):(m.myChart.options.scales.xAxes[0].customTicks=r,m.myChart.data.datasets=m.allSeries,m.myChart.options.scales.xAxes[0].ticks.max=p,m.myChart.update()))},BandPlot.prototype.resetZoom=function(){var t=this;t.myChart.resetZoom(),t.myChart.options.scales.xAxes[0].ticks.min=t.xLimit.xmin,t.myChart.options.scales.xAxes[0].ticks.max=t.xLimit.xmax,t.myChart.update()},BandPlot.prototype.updateTicks=function(t){var i,e=function(t,e){var n={};for(i=0;i<e.length;i++)n[e[i][0]]=e[i][1];var r=getValidPointNames([t]),a=-1==r.findIndex(function(t){return"GAMMA"==t})&&-1!=r.findIndex(function(t){return"G"==t})?function(t){return"G"==t&&(t="Γ"),t=(t=t.replace(/\-/gi,"—")).replace(/(\d)/gi,function(t,e,n,r){switch(e){case"0":return"₀";case"1":return"₁";case"2":return"₂";case"3":return"₃";case"4":return"₄";case"5":return"₅";case"6":return"₆";case"7":return"₇";case"8":return"₈";case"9":return"₉"}return e})}:function(t){return t=(t=(t=(t=(t=(t=t.replace(/GAMMA/gi,"Γ")).replace(/DELTA/gi,"Δ")).replace(/SIGMA/gi,"Σ")).replace(/LAMBDA/gi,"Λ")).replace(/\-/gi,"—")).replace(/_(.)/gi,function(t,e,n,r){switch(e){case"0":return"₀";case"1":return"₁";case"2":return"₂";case"3":return"₃";case"4":return"₄";case"5":return"₅";case"6":return"₆";case"7":return"₇";case"8":return"₈";case"9":return"₉"}return e})};return function(t){return void 0===t?t:a(t)}}(this.allData,t);return t.map(function(t){return[t[0],e(t[1])]})};