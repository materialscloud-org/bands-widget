// Materials Cloud bands structure widget v1.1.0
// 2020-07-02, MIT License
function getPathStringFromPathArray(a){var b=[],c="";return a.forEach(function(a){0===b.length?(b+=a[0],b+="-",b+=a[1]):(c!=a[0]&&(b+="|"+a[0]),b+="-",b+=a[1]),c=a[1]}),b}function getPathArrayFromPathString(a){var b=[],c=a.split("|");return c.forEach(function(a){pointsStrings=a.split("-"),pointsTrimmedStrings=pointsStrings.map(function(a){return a.trim()}),points=pointsTrimmedStrings.filter(function(a){return""!==a}),zip(points.slice(0,points.length-1),points.slice(1)).forEach(function(a){b.push([a[0],a[1]])})}),b}function getValidPointNames(a){var b=[];a.forEach(function(a){a.hasOwnProperty("paths")&&a.paths.forEach(function(a){b.push(a.from),b.push(a.to)})});var c=Array.from(new Set(b));return c.sort(),c}function BandPlot(a,b,c){this.divID=a,this.allData=[],this.allSeries=[],this.allColorInfo=[],this.currentPath=[],this.fermiEnergy=b,this.yLimit=c,this.yLabel="","undefined"!=typeof this.myChart&&this.myChart.destroy()}var zip=function(){var a=[].slice.call(arguments),b=0===a.length?[]:a.reduce(function(a,b){return a.length<b.length?a:b});return b.map(function(b,c){return a.map(function(a){return a[c]})})};BandPlot.prototype.addBandStructure=function(a,b){var c=["#555555","#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00"];if("undefined"==typeof b){var d=this.allColorInfo.length,e=tinycolor(c[d%c.length]);b=[e.toHexString(),e.darken(20).toHexString(),e.brighten(20).toHexString()]}this.allColorInfo.push(b),this.allData.push(a)},BandPlot.prototype.initChart=function(a){var b=this,c={type:"scatter",data:{datasets:this.allSeries},options:{legend:{display:!1},animation:{duration:0},responsive:!0,maintainAspectRatio:!1,tooltips:{displayColors:!1,backgroundColor:"#fcfcfc",borderColor:"#1565c0",borderWidth:1,bodyFontColor:"black",bodySpacing:6,cornerRadius:0,callbacks:{label:function(a,b){var c="y= "+a.yLabel.toFixed(2);return[c,"Drag to zoom or pan"]}}},scales:{xAxes:[{display:!0,ticks:{callback:function(a,b,c){return this.options.customTicks[b].label}},customTicks:a,afterBuildTicks:function(a,b){return a.options.customTicks.map(function(a){return a.value})}}],yAxes:[{display:!0,ticks:{callback:function(a,b,c){return 0!==b&&b!=c.length-1?a:void 0}},scaleLabel:{display:!0},gridLines:{display:!1}}]},zoom:{enabled:!0,mode:"y",drag:!0}}};b.yLimit&&(c.options.scales.yAxes[0].ticks.min=b.yLimit.ymin,c.options.scales.yAxes[0].ticks.max=b.yLimit.ymax),b.xLimit&&(c.options.scales.xAxes[0].ticks.min=b.xLimit.xmin,c.options.scales.xAxes[0].ticks.max=b.xLimit.xmax),b.yLabel&&(c.options.scales.yAxes[0].scaleLabel.labelString=b.yLabel);var d=document.getElementById(this.divID).getContext("2d");b.myChart=new Chart(d,c)},BandPlot.prototype.getDefaultPath=function(){return this.allData.length>0?(currentPathSpecification=this.allData[0].path,currentPathSpecification):[]},BandPlot.prototype.updateBandPlot=function(a,b){var c=this;void 0===b&&(b=!1);var d=.1;"undefined"==typeof a?currentPathSpecification=c.getDefaultPath():currentPathSpecification=a;var e=!1;if(c.currentPath.length!=currentPathSpecification.length?e=!0:zip(c.currentPath,currentPathSpecification).forEach(function(a){a[0][0]!=a[1][0]&&(e=!0),a[0][1]!=a[1][1]&&(e=!0)}),e||b){c.currentPath=currentPathSpecification;var f=function(a,b){for(var c=0;c<b.length;c++){var d=b[c];if(d.from==a[0]&&d.to==a[1])return{segment:d,reverse:!1};if(d.from==a[1]&&d.to==a[0])return{segment:d,reverse:!0}}return null},g=0;highSymmetryTicks=[],c.allSeries=[],currentPathSpecification.forEach(function(a,b){0===highSymmetryTicks.length?highSymmetryTicks.push([g,a[0]]):highSymmetryTicks[highSymmetryTicks.length-1][1]!=a[0]&&(highSymmetryTicks[highSymmetryTicks.length-1][1]+="|"+a[0]);var e,h=!1,i=null;c.allData.forEach(function(b,d){var j=f(a,b.paths);if(j){h=!0;var k=[],l=j.segment.x.length;if(j.reverse)for(e=j.segment.x.length-1;e>=0;e--)k.push(j.segment.x[l-1]-j.segment.x[e]);else for(e=0;l>e;e++)k.push(j.segment.x[e]-j.segment.x[0]);twoBandTypes=j.segment.two_band_types||!1,numBands=j.segment.values.length,null===i&&(i=k[k.length-1]);var m=1;if(k[k.length-1]>0)for(m=i/k[k.length-1],e=0;e<k.length;e++)k[e]*=m;i>0&&j.segment.values.forEach(function(b,e){var f,h=[];if(f=j.reverse?b.slice().reverse():b,c.fermiEnergy){var i=f.map(function(a){return a-c.fermiEnergy});f=i}zip(k,f).forEach(function(a){h.push({x:a[0]+g,y:a[1]})}),colorInfo=c.allColorInfo[d],twoBandTypes?2*e<numBands?lineColor=colorInfo[1]:lineColor=colorInfo[2]:lineColor=colorInfo[0];var l={label:a[0]+"-"+a[1]+"."+e,borderColor:lineColor,borderWidth:2,data:h,fill:!1,showLine:!0,pointRadius:0};c.allSeries.push(l)})}}),g+=h&&i>0?i:d,highSymmetryTicks.push([g,a[1]])});var h=c.updateTicks(highSymmetryTicks);ticksData=h.map(function(a,b){return{value:a[0],label:a[1]}}),c.xLimit={xmin:0,xmax:g},c.yLabel=c.allData[0].Y_label,void 0===c.yLabel&&(c.yLabel="Electronic bands (eV)"),void 0===c.myChart?c.initChart(ticksData):(c.myChart.options.scales.xAxes[0].customTicks=ticksData,c.myChart.data.datasets=c.allSeries,c.myChart.options.scales.xAxes[0].ticks.max=g,c.myChart.update())}},BandPlot.prototype.updateTicks=function(a){var b,c=this,d=function(a,c){var d={};for(b=0;b<c.length;b++)d[c[b][0]]=c[b][1];var e=function(a){return a=a.replace(/GAMMA/gi,"Γ"),a=a.replace(/DELTA/gi,"Δ"),a=a.replace(/SIGMA/gi,"Σ"),a=a.replace(/LAMBDA/gi,"Λ"),a=a.replace(/\-/gi,"—"),a=a.replace(/_(.)/gi,function(a,b,c,d){switch(b){case"0":return"₀";case"1":return"₁";case"2":return"₂";case"3":return"₃";case"4":return"₄";case"5":return"₅";case"6":return"₆";case"7":return"₇";case"8":return"₈";case"9":return"₉"}return b})},f=function(a){return"G"==a&&(a="Γ"),a=a.replace(/\-/gi,"—"),a=a.replace(/(\d)/gi,function(a,b,c,d){switch(b){case"0":return"₀";case"1":return"₁";case"2":return"₂";case"3":return"₃";case"4":return"₄";case"5":return"₅";case"6":return"₆";case"7":return"₇";case"8":return"₈";case"9":return"₉"}return b})},g=getValidPointNames([a]),h=!1;h=-1!=g.findIndex(function(a){return"GAMMA"==a})?!1:-1!=g.findIndex(function(a){return"G"==a})?!0:!1;var i;return i=h?f:e,function(a){return"undefined"==typeof a?a:(newLabel=i(a),newLabel)}},e=d(c.allData,a);return a.map(function(a){return[a[0],e(a[1])]})};